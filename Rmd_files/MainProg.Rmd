---
title: "MainProg"
author: "Rico Kronenberg, Lisa Marie Oehlschlägel"
date: "14 April 2018"
output: html_document
---

### MainProg - Main programm
BROOK90 simulates vertical soil water movement and daily evapotranspiration for all land surfaces at all times of year using a process-oriented approach with physically-meaningful parameters. Only enough streamflow generation pathways are included to allow comparison with measured streamflow where available (see [flow chart](http://www.ecoshift.net/brook/flowchrt.html)). The complexities of hillslope hydrology and spatial distribution have been omitted in order to focus on the details of the factors controlling evaporation.

BROOK90 can fill a wide range of needs: as a research tool to study the water budget and water movement on small plots, as a teaching tool for evaporation and soil water processes, as a water budget model for land managers and for predicting climate change effects, and as a fairly complex water budget model against which simpler models can be tested.

Input of daily precipitation and maximum and minimum temperatures is required, and daily solar radiation, vapor pressure, and wind speed are desirable. The model estimates interception and transpiration from a single layer (big leaf) plant canopy, soil and snow evaporation, snow accumulation and melt, and soil-water movement through one or more soil layers (including macropore-assisted infiltration). Stormflow is generated by a variable source area or simple pipe flow. Delayed flow is from soil drainage and a first-order groundwater storage. BROOK90 uses a Shuttleworth-Wallace modification to Penman-Monteith potential evaporation in order to separate transpiration and soil evaporation from sparse canopies. Actual transpiration is reduced below potential using Federer's method based on root density with depth, plant resistance, and a critical leaf-water potential. Water movement between soil layers is integrated using Darcy's Law and variable time-steps. 

The documenation of all scripts is done with R-Markdown. The main programm is used to set initial parameters, upload necessary scripts and the input data.

### Contents

* [Start Brook90](#start-brook90)
* [Load all variables](#load-all-variables)
* [Load meteorological and precipitation file](#load-meteorological-and-precipitation-file)
* [Change catchment parameters](#change-catchment-parameters)

### Start Brook90
Before loading all variables into Brook90 you have to remove all objects except functions with the following command.

```{r chunk1}
rm(list = setdiff(ls(), lsf.str()))
```

### Load all variables
Before loading the variables some parameters will be set.

Parameter |Value|Description
----------|-----|-------------
NPINT     |1    |number of precipitation intervals per day,  1 = 1 day, 24 = 24 hours per day
SUBDAYDATA|FALSE| #TRUE#TRUE
RRD       |0.55 |default ratio of solar radiation to potential
UWD       |3.0  |default wind speed at weather station

```{r chunk2}
NPINT <- 1         
SUBDAYDATA <- FALSE
RRD <- 0.55
UWD <- 3.0
```

It is important to define your "projectpath" to upload the necessary scripts including the variables and to run the programm. This path has to be the same as in the script B90V4.Rmd.

Running the Rmd-files causes that html-files of the included scripts will be produced. To store them in another directory as the Rmd-files it is defined where they will be saved ("output_html"). 

```{r chunk3, message=FALSE, results='hide'}
projectpath<-"../../Brook90_R"
output_html<-file.path(projectpath,"Documentation","HTML_Files")

rmarkdown::render(file.path(projectpath,"Rmd_files",'GLOBDECL.Rmd'),output_dir=output_html)

rmarkdown::render(file.path(projectpath,"Rmd_files",'AXX.Rmd'),output_dir = output_html)

rmarkdown::render(file.path(projectpath,"Rmd_files",'KPT.Rmd'),output_dir = output_html)

rmarkdown::render(file.path(projectpath,"Rmd_files",'EVP.Rmd'),output_dir = output_html)

rmarkdown::render(file.path(projectpath,"Rmd_files",'PET.Rmd'),output_dir = output_html)

rmarkdown::render(file.path(projectpath,"Rmd_files",'SUN.Rmd'),output_dir = output_html)

rmarkdown::render(file.path(projectpath,"Rmd_files",'WAT.Rmd'),output_dir = output_html)

rmarkdown::render(file.path(projectpath,"Rmd_files",'SNO.Rmd'),output_dir = output_html)

rmarkdown::render(file.path(projectpath,"Rmd_files",'B90V4_sub.Rmd'),output_dir = output_html)
```

The following table shows the description of the scriptnames:

Variable            | Description                           |Link
--------------------|---------------------------------------|------------------
GLOBDECL            | Global declaration of catchment area  |[GLOBDECL](./GLOBDECL.Rmd)
AXX                 | Auxiliary routines                    |[AXX](./AXX.Rmd)
KPT                 | Soil water properties                 |[KPT](./KPT.Rmd)
EVP                 | Interception and transpiration        |[EVP](./EVP.Rmd)
PET                 | Potential evaporation                 |[PET](./PET.Rmd)
SUN                 | Radiation                             |[SUN](./SUN.Rmd)
WAT                 | Water movement in Soil                |[WAT](./WAT.Rmd)
SNO                 | Snow accumulation and melt            |[SNO](./SNO.Rmd)
B90V4_sub           | Subroutine                            |[B90V4_sub](./B90V4_sub.Rmd)

### Load meteorological and precipitation file
Both datasets will be uploaded and with this data for each set a matrix has been created. The datasets don't have have a header, so the following table shows the included data.

column  |Meteorological file      | Precipitation file              
--------|-------------------------|-------------
1       |Year                     |Year
2       |Month                    |Month
3       |Day                      |Day
4       |Solar radiation (MJ/m2)  |Number of precipitation interval
5       |TMAX(°C)                 |Precipitation (mm)
6       |TMIN(°C)                 |Average measured streamflow rate (mm/d),if not available it should be set -1
7       |Vapor pressure (kPa)     |/
8       |Wind speed (m/s)         |/
9       |Precipitation (mm)       |/
10      |Measured streamflow (mm) |/

If you use your own meteorological or precipitation file, make sure that your files have the same shape as the example files. All data have to be in the order and the units like in the shown table. The consistency of your meteorological data can be checked in the Rmd-script consistency_meteoFile.Rmd.

The input data (meteorological data, precipitation data, catchment parameters) are located in a different folder ("Input_data").

```{r chunk4}
meteoFile <-read.table(file.path(projectpath,"Input_data","data_input_WB_1999_point.txt"))
MData<-matrix(meteoFile)

precFile <-read.table(file.path(projectpath,"Input_data","P_WBG_0060_Minuten_1999_point.txt"))
MhhData<-matrix(precFile)
```

### Change catchment parameters
#### Canopy
The canopy-file includes 18 parameters and the root density (ROOTDEN), with 25 pairs of root layer thickness (mm) and relative root density per unit volume. The first and third row of ROOTDEN are the root layer thickness and second and fourth row contain the relative root density per unit volume.

If changes need to be done, change them in the textfile "canopy.txt" or use your on file with the same formatting.

```{r chunk5, warning=FALSE}
canopy_file <- read.table(file.path(projectpath,"Input_data","canopy.txt"), header = FALSE, fill=TRUE , dec = "." , sep = ",", strip.white = TRUE)

#canopy parameters
canopy_varname <- as.character(canopy_file[,1])
canopy_varvalue <- as.character(canopy_file [,2])
quant_canopy <- 18

for (i in 1:quant_canopy){
  a <- unlist(canopy_varname[i])
  b <- as.numeric(unlist(canopy_varvalue[i]))
  assign(a,b)
  rm(a,b)
}

#ROOTDEN
roota <- strsplit(canopy_varname[20],"[ ]+")
rootb <- unlist(roota)
rootc <- as.numeric(rootb)
rootaa <- strsplit(canopy_varname[22],"[ ]+")
rootbb <- unlist(rootaa)
rootcc <- as.numeric(rootbb)
root_a <- c(rootc,rootcc)
root_a[is.na(root_a)] <- 0

rootd <- strsplit(canopy_varname[21],"[ ]+")
roote <- unlist(rootd)
rootf <- as.numeric(roote)
rootdd <- strsplit(canopy_varname[23],"[ ]+")
rootee <- unlist(rootdd)
rootff <- as.numeric(rootee)
root_b <- c(rootf,rootff)
root_b[is.na(root_b)] <- 0

rootden <- as.vector(rbind(root_a,root_b)) 
assign(canopy_varname[19],rootden)

rm(roota,rootb,rootc,rootd,roote,rootf,rootaa,rootbb,rootcc,root_a,rootdd,rootee,rootff,root_b,quant_canopy,canopy_varvalue,canopy_varname,rootden)
```

#### Fixed
This file contains 43 parameters that can be changed in the textfile.

```{r chunk6}
fixed_file <-read.table(file.path(projectpath,"Input_data","fixed.txt"), header = FALSE, fill=TRUE, sep = "," , dec = "." , row.names = 1)

fixed_varname <- rownames(fixed_file)
fixed_varvalue <- fixed_file [,c(1)]

quant_fixed = length(fixed_varname) - 1

for (i in 1:quant_fixed){
  a <- unlist(fixed_varname[i])
  b <- unlist(fixed_varvalue[i])
  assign(a,b)
  rm(a,b)
}

rm(fixed_varname,fixed_varvalue,quant_fixed)
```

#### Flow Standard
Different flow parameters are included in this file. All 13 values can be changed if it is necessary.

```{r chunk7}
flow_file <-read.table(file.path(projectpath,"Input_data","flow_standard.txt"), header = FALSE, fill=TRUE, sep = "," , dec = "." , row.names = 1)

flow_varname <- rownames(flow_file)
flow_varvalue <- flow_file [,c(1)]

quant_flow = length(flow_varname) - 1

for (i in 1:quant_flow){
  a <- unlist(flow_varname[i])
  b <- unlist(flow_varvalue[i])
  assign(a,b)
  rm(a,b)
}

rm(flow_varname,flow_varvalue,quant_flow)
```

#### Initial
The initial file contains 4 parameters and PSIMIN, the initial matric soil water potential for layer, with 25 layers.

```{r chunk8}
initial_file <-read.table(file.path(projectpath,"Input_data","initial.txt"),header = FALSE,fill=TRUE,sep = ",",dec = ".",row.names = 1)

initial_varname <- rownames(initial_file)
initial_varvalue <- as.character(initial_file [,1])
quant_initial <- 4

for (i in 1:quant_initial){
  a <- unlist(initial_varname[i])
  b <- as.numeric(unlist(initial_varvalue[i]))
  assign(a,b)
  rm(a,b)
}

#PSIMIN
PSIMIN <- as.numeric(initial_varvalue[6:30])

rm(initial_varname,initial_varvalue,quant_initial)
```

#### Location
The location-file has a little bit more complicated structure, 5 parameters at the beginning, the average duration of daily precip by month (DURATN), ten pairs of DOY and relative canopy height (RELHT) and ten pairs of DOY and relative LAI (RELLAI). But they can be easily changed in the file.

```{r chunk9}
location_file <-read.table(file.path(projectpath,"Input_data","location.txt"), header = FALSE, fill=TRUE, sep = "," , dec = ".", strip.white = TRUE)

location_varname <- as.character(location_file[,1])
location_varvalue <- as.character(location_file [,2])
quant_location <- 5

for (i in 1:quant_location){
  a <- unlist(location_varname[i])
  b <- as.numeric(unlist(location_varvalue[i]))
  assign(a,b)
  rm(a,b)
}

#DURATN
duratna <- strsplit(location_varvalue[6],"[ ]+")
duratnb <- unlist(duratna)
duratn<- as.numeric(duratnb)
assign(location_varname[6],duratn)

rm(duratna,duratnb,duratn)

#RELHT
hta <- strsplit(location_varvalue[7],"[ ]+")
htb<- unlist(hta)
ht_a <- suppressWarnings(as.numeric(htb))
ht_a[is.na(ht_a)] <- 0

htc <- strsplit(location_varname[8],"[ ]+")
htd <- unlist(htc)
ht_b <- suppressWarnings(as.numeric(htd))
ht_b[is.na(ht_b)] <- 0

relht <- as.vector(rbind(ht_a,ht_b)) 
assign(location_varname[7],relht)

rm(hta,htb,htc,htd,ht_a,ht_b,relht)

#RELLAI
laia <- strsplit(location_varvalue[9],"[ ]+")
laib<- unlist(laia)
lai_a <- suppressWarnings(as.numeric(laib))
lai_a[is.na(lai_a)] <- 0

laic <- strsplit(location_varname[10],"[ ]+")
laid <- unlist(laic)
lai_b <- suppressWarnings(as.numeric(laid))
lai_b[is.na(lai_b)] <- 0

rellai <- as.vector(rbind(lai_a,lai_b)) 
assign(location_varname[9],rellai)

rm(laia,laib,laic,laid,lai_a,lai_b,rellai)
rm(location_varname,location_varvalue,quant_location)
```

#### SOIL
In this file the number of layers (NLAYER) can be changed and eight other soil parameters:

* THICK - layer thicknesses (mm)
* STONEF - stone volume fraction (unitless)
* PSIF - matric potential at field capacity (kPa)
* THETAF - volumetric water content at field capacity
* THSAT - theta at saturation, matrix porosity
* BEXP - exponent for psi-theta relation
* KF - hydraulic conductivity at field capacity (mm/d)
* WETINF - wetness at dry end of near-saturation range

```{r chunk10}
soil_file <-read.table(file.path(projectpath,"Input_data","soil.txt"), header = FALSE, fill=TRUE , dec = "." , sep = "", strip.white = TRUE)

soil_var1 <- as.character(soil_file[,1])
soil_var2 <- as.character(soil_file[,2])
soil_var3 <- as.character(soil_file[,3])
soil_var4 <- as.character(soil_file[,4])
soil_var5 <- as.character(soil_file[,5])
soil_var6 <- as.character(soil_file[,6])
soil_var7 <- as.character(soil_file[,7])
soil_var8 <- as.character(soil_file[,8])

# NLAYER
a_nlayer <- unlist(soil_var1[1])
a_nlayer <- as.character(gsub(",","",a_nlayer))
b_nlayer <- as.numeric(unlist(soil_var2[1]))
assign(a_nlayer,b_nlayer)
rm(a_nlayer,b_nlayer)

# THICK
a_thick <- unlist(soil_var1[2])
b_thick <- as.numeric(unlist(soil_var1[3:27]))
assign(a_thick,b_thick)
rm(a_thick,b_thick)

# STONEF
a_stonef <- unlist(soil_var2[2])
b_stonef <- as.numeric(unlist(soil_var2[3:27]))
assign(a_stonef,b_stonef)
rm(a_stonef,b_stonef)

# PSIF
a_psif <- unlist(soil_var3[2])
b_psif <- as.numeric(unlist(soil_var3[3:27]))
assign(a_psif,b_psif)
rm(a_psif,b_psif)

# THETAF
a_thetaf <- unlist(soil_var4[2])
b_thetaf <- as.numeric(unlist(soil_var4[3:27]))
assign(a_thetaf,b_thetaf)
rm(a_thetaf,b_thetaf)

# THSAT
a_thsat <- unlist(soil_var5[2])
b_thsat <- as.numeric(unlist(soil_var5[3:27]))
assign(a_thsat,b_thsat)
rm(a_thsat,b_thsat)

# BEXP
a_bexp <- unlist(soil_var6[2])
b_bexp <- as.numeric(unlist(soil_var6[3:27]))
assign(a_bexp,b_bexp)
rm(a_bexp,b_bexp)

# KF
a_kf <- unlist(soil_var7[2])
b_kf <- as.numeric(unlist(soil_var7[3:27]))
assign(a_kf,b_kf)
rm(a_kf,b_kf)

# WETINF
a_wetinf <- unlist(soil_var8[2])
b_wetinf <- as.numeric(unlist(soil_var8[3:27]))
assign(a_wetinf,b_wetinf)
rm(a_wetinf,b_wetinf)

rm(soil_var1,soil_var2,soil_var3,soil_var4,soil_var5,soil_var6,soil_var7,soil_var8)
```

To upload the scripts with the variables and the datasets use "Run from source" for the script "MainProg.R". If this is done the model can be started. The file "B90V4.R" has to be opened and started with "Run from source" to run BROOK90 in R.
